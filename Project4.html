<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKAXLdXo8EpSPENhC50ANq5YNmleHORr8&libraries=places,visualization,routes&callback=initialize" async defer></script>
  </head>

  <body>
    <form id="directionsForm">
      <label for="startAddress">Start Address:</label>
      <input type="text" id="startAddress" required>
   
      <label for="endAddress">End Address:</label>
      <input type="text" id="endAddress" required>
   
      <button type="submit">Directions</button>
   </form>

   <div id="map" style="height: 500px;"></div>

   <script>
    function initialize() {
      var start = document.getElementById('startAddress');
      var end = document.getElementById('endAddress');

      var autocompleteStart = new google.maps.places.Autocomplete(start);
      var autocompleteEnd = new google.maps.places.Autocomplete(end);

      var map;

      if (navigator.geolocation) 
      {
        navigator.geolocation.getCurrentPosition(
          function (position) 
          {
            const currentLocation = new google.maps.LatLng(
              position.coords.latitude,
              position.coords.longitude
            );

            map = new google.maps.Map(document.getElementById('map'), 
            {
              zoom: 13,
              center: currentLocation
            });

            const marker = new google.maps.Marker({
              position: currentLocation,
              map: map,
              title: 'Current Location',
            });

            const directionsService = new google.maps.DirectionsService;
            const directionsDisplay = new google.maps.DirectionsRenderer;
            directionsDisplay.setMap(map);

            const trafficLayer = new google.maps.TrafficLayer()
            trafficLayer.setMap(map)

            document.getElementById('directionsForm').addEventListener('submit', function (event) 
            {
              event.preventDefault();
              displayRoute(directionsService, directionsDisplay);
            });
          }
        )
      }
    }

    async function displayRoute(directionsService, directionsDisplay) {
      var start = document.getElementById('startAddress').value;
      var end = document.getElementById('endAddress').value;
      
      directionsService.route(
        {
          origin: start,
          destination: end,
          travelMode: 'DRIVING',
        },
        function (response, status)
        {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);

            console.log(response)

            const route = response.routes[0].legs[0];
            console.log('Route: ', route)

            route.steps.forEach((element, index) => {
              const duration = element.duration.text;
              const distance = element.distance.text;

              console.log(`Leg ${index + 1}: `)
              console.log('Duration:', duration);
              console.log('Distance:', distance);

              
            });
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        }
      );

      const apiKey = 'AIzaSyAKAXLdXo8EpSPENhC50ANq5YNmleHORr8';
      const apiUrl = 'https://routes.googleapis.com/directions/v2:computeRoutes';

      const body = JSON.stringify({
        origin: { address: start },
        destination: { address: end },
        travelMode: 'DRIVE',
        extraComputations: ['TRAFFIC_ON_POLYLINE'],
        routingPreference: 'TRAFFIC_AWARE_OPTIMAL'
      });

      const headers = {
        'Content-Type': 'application/json',
        'X-Goog-Api-Key': apiKey,
        'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.polyline,routes.legs.polyline,routes.travelAdvisory,routes.legs.travelAdvisory'
      };

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: headers,
          body: body
        });

        if (response.ok) {
          const result = await response.json();
          //console.log('API Response:', result);

          const travelAdvisory = result.routes[0].travelAdvisory;
          console.log('Travel Advisory:', travelAdvisory);

          const currentDistance = 4;
          console.log(travelAdvisory.speedReadingIntervals);

          //For each entry in the speedReadingIntervals array, determine if the current distance lands in between the ranges and match that distance to the corresponding traffic condition
          travelAdvisory.speedReadingIntervals.forEach((interval) => {
            const startIndex = interval.startPolylinePointIndex;
            const endIndex = interval.endPolylinePointIndex;

            if(currentDistance >= startIndex && currentDistance < endIndex)
            {
              const trafficCondition = interval.speed;
              console.log(trafficCondition);
            }
          });
        } else {
          console.error('API Request failed:', response.statusText);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
   </script>
  </body>
</html>